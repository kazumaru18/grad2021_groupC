{% load static %}
<!DOCTYPE html>
<html>
  <head>
    <title>Simple Map</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <link href="{% static 'css/sakata.css' %}" rel="stylesheet" />
    <script src="{% static 'css/index.js' %}"></script>
  </head>
  <body>
    <header>
      <h3>ã‹ã‚“ã“ãƒ¼ã™ã„ã—ã‚“ã¾ã£ã·ğŸ°</h3>
    </header>
    <hr>
    <input
      id="pac-input"
      class="controls"
      type="text"
      placeholder="Search Box"
    />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script>
  

    function initMap() {
      var target = document.getElementById('gmap');  
      var tokyo = {lat: 35.681167, lng: 139.767052};  //æ±äº¬é§…ã®ç·¯åº¦çµŒåº¦
      var map = new google.maps.Map(document.getElementById('gmap'), {
        center: tokyo,
        zoom: 16
        // mapTypeControl: false,

      });
      
      //æƒ…å ±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ç”Ÿæˆï¼ˆå¾Œã§ãƒãƒ¼ã‚«ãƒ¼ã«ç´ä»˜ã‘ï¼‰
      var infowindow = new google.maps.InfoWindow();
      
      //PlacesService ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ç”Ÿæˆï¼ˆå¼•æ•°ã« map ã‚’æŒ‡å®šï¼‰
      var service = new google.maps.places.PlacesService(map);
      
      if(!navigator.geolocation){ 
        //æƒ…å ±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ä½ç½®ã‚’ãƒãƒƒãƒ—ã®ä¸­å¿ƒä½ç½®ã«æŒ‡å®š
        infowindow.setPosition(map.getCenter());
        //æƒ…å ±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¨­å®š
        infowindow.setContent('Geolocation ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
        //æƒ…å ±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’è¡¨ç¤º
        infowindow.open(map);
      }
      
      //ãƒ–ãƒ©ã‚¦ã‚¶ãŒå¯¾å¿œã—ã¦ã„ã‚‹å ´åˆã€position ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½ç½®æƒ…å ±ãŒå…¥ã‚‹
      navigator.geolocation.getCurrentPosition(function(position) { 
        //position ã‹ã‚‰ç·¯åº¦çµŒåº¦ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½ç½®ï¼‰ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—å¤‰æ•°ã«ä»£å…¥
        var pos = {  
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        //æƒ…å ±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ç¾åœ¨ä½ç½®ã‚’æŒ‡å®š
        infowindow.setPosition(pos);
        //æƒ…å ±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¨­å®š
        infowindow.setContent('ç¾åœ¨ä½ç½®ã‚’å–å¾—ã—ã¾ã—ãŸã€‚');
        //æƒ…å ±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’è¡¨ç¤º
        infowindow.open(map);
        //ãƒãƒƒãƒ—ã®ä¸­å¿ƒä½ç½®ã‚’æŒ‡å®š
        map.setCenter(pos);
        
        //ç¨®é¡ï¼ˆã‚¿ã‚¤ãƒ—ï¼‰ã‚„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚‚ã¨ã«æ–½è¨­ã‚’æ¤œç´¢ï¼ˆãƒ—ãƒ¬ã‚¤ã‚¹æ¤œç´¢ï¼‰ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ nearbySearch()
        service.nearbySearch({
          location: pos,  //æ¤œç´¢ã™ã‚‹ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³
          radius: 500,  //æ¤œç´¢ã™ã‚‹åŠå¾„ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
          type: ['store']  //ã‚¿ã‚¤ãƒ—ã§æ¤œç´¢ã€‚æ–‡å­—åˆ—ã¾ãŸã¯ãã®é…åˆ—ã§æŒ‡å®š
          //ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ã™ã‚‹å ´åˆã¯ name:'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³' ã‚„ ['ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³','ä¸­è¯'] ã®ã‚ˆã†ã«æŒ‡å®š
        }, callback);  //ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ï¼ˆcallbackï¼‰ã¯åˆ¥é€”å®šç¾©
     
        //ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã«ã¯ results, status ãŒæ¸¡ã•ã‚Œã‚‹ã®ã§ã€status ã«ã‚ˆã‚Šæ¡ä»¶åˆ†å²
        function callback(results, status) {
          // console.log(pos['lat']);
          $.ajax({
            url: 'http://webservice.recruit.co.jp/hotpepper/gourmet/v1/?key=04b892c025d4a7cf&lat=35.862423&lng=139.971296&range=3&order=4&count=50&format=jsonp',
            type: 'GET',
            dataType: 'jsonp',
            jsonpCallback: 'callback'
          }).done(function(data) {
          // console.log(data['results']['shop'][0]['address']); // æˆåŠŸæ™‚ ã“ã®å‡¦ç†ã¯ãƒ€ãƒŸãƒ¼ãªã®ã§å¤‰æ›´ã—ã¦ãã ã•ã„
            // console.log(data); // æˆåŠŸæ™‚ ã“ã®å‡¦ç†ã¯ãƒ€ãƒŸãƒ¼ãªã®ã§å¤‰æ›´ã—ã¦ãã ã•ã„
            var res = data['results']['shop'];
            for (var k in res) {
              gourmetMarker(res[k]);
            }
          }).fail(function(data) {
            console.log("no"); // å¤±æ•—æ™‚
          });
          // status ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå®šæ•°ã§åˆ¤å®šï¼ˆOK ã®å ´åˆã¯ results ãŒé…åˆ—ã§è¿”ã£ã¦ãã¾ã™ï¼‰
          if (status === google.maps.places.PlacesServiceStatus.OK) {
            //results ã®æ•°ã ã‘ for æ–‡ã§ç¹°ã‚Šè¿”ã—å‡¦ç†
            for (var i = 0; i < results.length; i++) {
              //createMarker() ã¯ãƒãƒ¼ã‚«ãƒ¼ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ï¼ˆåˆ¥é€”å®šç¾©ï¼‰
              createMarker(results[i]);
            }
          }
        }
      }, function() {  //ä½ç½®æƒ…å ±ã®å–å¾—ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ–ãƒ­ãƒƒã‚¯ã—ãŸå ´åˆã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
        //æƒ…å ±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ä½ç½®ã‚’ãƒãƒƒãƒ—ã®ä¸­å¿ƒä½ç½®ã«æŒ‡å®š
        infowindow.setPosition(map.getCenter());
        //æƒ…å ±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¨­å®š
        infowindow.setContent('Error: Geolocation ãŒç„¡åŠ¹ã§ã™ã€‚');
        //æƒ…å ±ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’è¡¨ç¤º
        infowindow.open(map);
      });   
      
      //ãƒãƒ¼ã‚«ãƒ¼ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ï¼ˆå¼•æ•°ã«ã¯æ¤œç´¢çµæœã®é…åˆ— results[i] ãŒå…¥ã£ã¦ãã¾ã™ï¼‰
      function createMarker(place) {
        //var placeLoc = place.geometry.location; 
        var marker = new google.maps.Marker({
          map: map,
          position: place.geometry.location  //results[i].geometry.location
        });
     
        //ãƒãƒ¼ã‚«ãƒ¼ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠã‚’è¨­å®š
        marker.addListener('click', function() {
          var i = place.name + "<br>" + place.rating;
          infowindow.setContent(i);  //results[i].name
          infowindow.open(map, this);
        });
      }

      

      function gourmetMarker(res) {
        //var placeLoc = place.geometry.location; 
        var marker = new google.maps.Marker({
          map: map,
          position: {lat: res['lat'], lng: res['lng']}  //results[i].geometry.location
        });
     
        //ãƒãƒ¼ã‚«ãƒ¼ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠã‚’è¨­å®š
        marker.addListener('click', function() {
          var i = "<img src=res['logo_image']>" + res['name'] + "<br>" + res['address'] + "<br>" + res['access'] + "<br>" + "<img src=res['photo']['mobile']['s']>";
          infowindow.setContent(i);  //results[i].name
          infowindow.open(map, this);
        });
      }
    }
        
    </script> 
    <div id="gmap" style="height: 600px;width:100%"></div> <!-- åœ°å›³ã‚’è¡¨ç¤ºã™ã‚‹é ˜åŸŸ -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAaKn-PcSb_pTFwH6IJ2_ANNLKsHVMHWwU&callback=initMap&libraries=places" async defer></script>
    
  </body>
</html>